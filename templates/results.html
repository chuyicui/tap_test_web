{% extends "base.html" %}

{% block content %}
<div class="glass-card rounded-3xl p-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <i class="fas fa-chart-line text-5xl text-green-500 mb-4"></i>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Test Results</h1>
        <p class="text-lg text-gray-600">Your UPDRS Finger Tapping Assessment</p>
    </div>
    
    <!-- Mood Summary -->
    <div class="bg-gradient-to-r from-pink-50 to-purple-50 rounded-2xl p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-heart mr-2 text-pink-500"></i>
            Mood Assessment
        </h2>
        <div id="moodDisplay" class="text-center">
            <div class="text-4xl mb-2" id="moodEmoji">üòê</div>
            <div class="text-lg font-medium text-gray-700" id="moodText">Neutral</div>
        </div>
    </div>
    
    <!-- Results Summary -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Right Hand Results -->
        <div class="bg-white rounded-2xl p-6 shadow-sm">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-hand-paper mr-2 text-blue-500"></i>
                Right Hand
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Total Taps:</span>
                    <span class="text-2xl font-bold text-blue-600" id="rightTaps">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Taps per Second:</span>
                    <span class="text-lg font-semibold text-blue-600" id="rightRate">0.0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Average Distance:</span>
                    <span class="text-lg font-semibold text-blue-600" id="rightAvgDist">0</span>
                </div>
            </div>
        </div>
        
        <!-- Left Hand Results -->
        <div class="bg-white rounded-2xl p-6 shadow-sm">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-hand-paper mr-2 text-red-500"></i>
                Left Hand
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Total Taps:</span>
                    <span class="text-2xl font-bold text-red-600" id="leftTaps">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Taps per Second:</span>
                    <span class="text-lg font-semibold text-red-600" id="leftRate">0.0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Average Distance:</span>
                    <span class="text-lg font-semibold text-red-600" id="leftAvgDist">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="grid lg:grid-cols-2 gap-6 mb-8">
        <!-- Right Hand Chart -->
        <div class="chart-container">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                Right Hand Distance Over Time
            </h3>
            <canvas id="rightChart" width="400" height="200"></canvas>
        </div>
        
        <!-- Left Hand Chart -->
        <div class="chart-container">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-chart-line mr-2 text-red-500"></i>
                Left Hand Distance Over Time
            </h3>
            <canvas id="leftChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- Analysis -->
    <div class="bg-gray-50 rounded-2xl p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-microscope mr-2 text-indigo-500"></i>
            Analysis
        </h3>
        <div id="analysisText" class="text-gray-700 leading-relaxed">
            Loading analysis...
        </div>
    </div>
    
    <!-- Actions -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="downloadReport()" class="btn-primary text-white px-8 py-4 rounded-xl text-lg font-semibold">
            <i class="fas fa-download mr-2"></i>
            Download Report
        </button>
        <button onclick="startNewTest()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-xl text-lg font-semibold">
            <i class="fas fa-redo mr-2"></i>
            New Test
        </button>
    </div>
</div>

<script>
let rightChart, leftChart;

async function loadResults() {
    try {
        const response = await axios.get('/api/get_results');
        const data = response.data;
        
        // Update mood display
        updateMoodDisplay(data.mood_rating);
        
        // Update results
        updateResults(data.right_hand, data.left_hand, data.test_duration);
        
        // Create charts
        createCharts(data.right_hand, data.left_hand);
        
        // Generate analysis
        generateAnalysis(data.right_hand, data.left_hand);
        
    } catch (error) {
        console.error('Error loading results:', error);
        alert('Error loading results. Please try again.');
    }
}

function updateMoodDisplay(rating) {
    const moodEmojis = ['', 'üò¥', 'üòî', 'üòê', 'üòä', 'ü§©'];
    const moodTexts = ['', 'Very Tired', 'Low Energy', 'Neutral', 'Good', 'Excellent'];
    
    document.getElementById('moodEmoji').textContent = moodEmojis[rating] || 'üòê';
    document.getElementById('moodText').textContent = moodTexts[rating] || 'Neutral';
}

function updateResults(rightHand, leftHand, testDuration) {
    // Right hand
    document.getElementById('rightTaps').textContent = rightHand.taps;
    document.getElementById('rightRate').textContent = (rightHand.taps / testDuration).toFixed(1);
    
    const rightAvgDist = rightHand.distances.length > 0 ? 
        rightHand.distances.reduce((a, b) => a + b, 0) / rightHand.distances.length : 0;
    document.getElementById('rightAvgDist').textContent = Math.round(rightAvgDist);
    
    // Left hand
    document.getElementById('leftTaps').textContent = leftHand.taps;
    document.getElementById('leftRate').textContent = (leftHand.taps / testDuration).toFixed(1);
    
    const leftAvgDist = leftHand.distances.length > 0 ? 
        leftHand.distances.reduce((a, b) => a + b, 0) / leftHand.distances.length : 0;
    document.getElementById('leftAvgDist').textContent = Math.round(leftAvgDist);
}

function createCharts(rightHand, leftHand) {
    // Right hand chart
    const rightCtx = document.getElementById('rightChart').getContext('2d');
    if (rightChart) rightChart.destroy();
    
    rightChart = new Chart(rightCtx, {
        type: 'line',
        data: {
            labels: rightHand.timestamps.map((t, i) => i),
            datasets: [{
                label: 'Distance (pixels)',
                data: rightHand.distances,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Distance (pixels)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Time Points'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Left hand chart
    const leftCtx = document.getElementById('leftChart').getContext('2d');
    if (leftChart) leftChart.destroy();
    
    leftChart = new Chart(leftCtx, {
        type: 'line',
        data: {
            labels: leftHand.timestamps.map((t, i) => i),
            datasets: [{
                label: 'Distance (pixels)',
                data: leftHand.distances,
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Distance (pixels)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Time Points'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function generateAnalysis(rightHand, leftHand) {
    const rightRate = rightHand.taps / 10;
    const leftRate = leftHand.taps / 10;
    const rightAvgDist = rightHand.distances.length > 0 ? 
        rightHand.distances.reduce((a, b) => a + b, 0) / rightHand.distances.length : 0;
    const leftAvgDist = leftHand.distances.length > 0 ? 
        leftHand.distances.reduce((a, b) => a + b, 0) / leftHand.distances.length : 0;
    
    let analysis = `<p class="mb-4">Your finger tapping performance shows the following characteristics:</p>`;
    
    // Rate analysis
    if (rightRate > 3 && leftRate > 3) {
        analysis += `<p class="mb-2"><strong>Excellent Performance:</strong> Both hands demonstrated high tapping rates (${rightRate.toFixed(1)} and ${leftRate.toFixed(1)} taps/second), indicating good motor control and coordination.</p>`;
    } else if (rightRate > 2 && leftRate > 2) {
        analysis += `<p class="mb-2"><strong>Good Performance:</strong> Both hands showed moderate tapping rates (${rightRate.toFixed(1)} and ${leftRate.toFixed(1)} taps/second), suggesting adequate motor function.</p>`;
    } else {
        analysis += `<p class="mb-2"><strong>Lower Performance:</strong> Tapping rates were ${rightRate.toFixed(1)} and ${leftRate.toFixed(1)} taps/second. This may indicate reduced motor control or coordination.</p>`;
    }
    
    // Symmetry analysis
    const rateDifference = Math.abs(rightRate - leftRate);
    if (rateDifference < 0.5) {
        analysis += `<p class="mb-2"><strong>Good Symmetry:</strong> Both hands performed similarly, indicating balanced motor function.</p>`;
    } else {
        analysis += `<p class="mb-2"><strong>Asymmetry Detected:</strong> There's a notable difference between hands (${rateDifference.toFixed(1)} taps/second difference), which may warrant further evaluation.</p>`;
    }
    
    // Distance analysis
    if (rightAvgDist < 50 && leftAvgDist < 50) {
        analysis += `<p class="mb-2"><strong>Precise Movement:</strong> Average finger distances were low (${Math.round(rightAvgDist)} and ${Math.round(leftAvgDist)} pixels), indicating good precision and control.</p>`;
    } else {
        analysis += `<p class="mb-2"><strong>Variable Precision:</strong> Finger distances averaged ${Math.round(rightAvgDist)} and ${Math.round(leftAvgDist)} pixels, suggesting some variability in movement precision.</p>`;
    }
    
    analysis += `<p class="mt-4 text-sm text-gray-600"><em>Note: This analysis is for informational purposes only and should not replace professional medical evaluation.</em></p>`;
    
    document.getElementById('analysisText').innerHTML = analysis;
}

async function downloadReport() {
    try {
        const response = await axios.get('/api/download_report', {
            responseType: 'blob'
        });
        
        const blob = new Blob([response.data], { type: 'application/pdf' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `updrs_report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Error downloading report:', error);
        alert('Error downloading report. Please try again.');
    }
}

async function startNewTest() {
    try {
        await axios.get('/api/reset');
        window.location.href = '/';
    } catch (error) {
        console.error('Error resetting test:', error);
    }
}

// Load results when page loads
document.addEventListener('DOMContentLoaded', loadResults);
</script>
{% endblock %}

